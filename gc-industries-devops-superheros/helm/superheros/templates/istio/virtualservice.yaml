apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: superheros-routing
  namespace: {{ .Values.namespace }}
spec:
  hosts:
    - "*"
  gateways:
    - superheros-gateway

  http:
    - match:
        - uri:
            prefix: /api/catalog
      route:
{{- $weights := dict "v1" 40 "v2" 30 "v3" 30 }}
{{- range $i, $ver := .Values.services.catalog.versions }}
        - destination:
            host: catalog
            subset: {{ $ver.name }}
            port:
              number: 8081
          weight: {{ index $weights $ver.name | default 30 }}
{{- end }}

    - match:
        - uri:
            prefix: /api/orders
      route:
        - destination:
            host: orders
            port:
              number: 8082

    - match:
        - uri:
            prefix: /api/inventory
      route:
        - destination:
            host: inventory
            port:
              number: 8083

    - match:
        - uri:
            prefix: /api/payment
      route:
        - destination:
            host: payment
            port:
              number: 8084

    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: frontend
            port:
              number: 80
